# AI音乐平台 V0.4 - 推荐系统版本

## 1. 系统概述

V0.4版本在V0.3基础上添加了推荐系统服务,实现个性化音乐推荐和协同过滤功能。

### 1.1 系统架构
```yaml
架构图:
                    ┌→ [用户认证服务8081]
                    ├→ [音乐生成服务8080]
  [前端Next.js] → [API网关] 
                    ├→ [社交功能服务8082]
                    └→ [推荐系统服务8083]
                           ↓
                    [PostgreSQL & Redis]
```

### 1.2 核心功能
```yaml
继承V0.3功能:
  - AI音乐生成API调用
  - 用户认证授权
  - 音乐收藏功能
  - 社交互动功能
  
新增功能:
  - 个性化音乐推荐
  - 基于用户的协同过滤
  - 基于内容的推荐
  - 实时推荐更新
  - 推荐效果分析
```

## 2. 技术栈

### 2.1 后端技术
```yaml
框架与库:
  - Spring Boot 3.2
  - Spring Security
  - Spring Data JPA
  - Spring Web
  - Spring Actuator
  - Spring WebSocket
  - Apache Spark MLlib
  - Apache Kafka
  - Lombok
  - MapStruct
  - OpenAPI (Swagger)

数据库与缓存:
  - PostgreSQL 14
  - Redis (缓存&特征存储)
  - Elasticsearch (搜索&特征索引)
  - Flyway (数据库迁移)

构建工具:
  - Maven
  - Docker
  - Docker Compose

测试:
  - JUnit 5
  - Testcontainers
  - REST Assured
```

### 2.2 前端技术
```yaml
框架与库:
  - Next.js 14
  - React 18
  - TypeScript 5
  - TailwindCSS
  - Shadcn UI
  - React Query
  - Axios
  - Socket.IO Client
  - JWT Decode

构建工具:
  - Node.js 18
  - npm
```

## 3. 服务设计

### 3.1 推荐系统服务 (recommendation-service)
```yaml
端口: 8083
职责: 
  - 用户行为分析
  - 特征工程
  - 模型训练
  - 推荐生成
  - 效果分析

API接口:
  # 个性化推荐
  GET /api/v1/recommendations/personalized:
    描述: 获取个性化推荐
    请求头:
      Authorization: Bearer <token>
    参数:
      page: integer     # 页码
      size: integer     # 每页数量
      type: string      # 推荐类型(similar/collaborative/content)
    响应:
      content: array    # 推荐列表
      totalElements: integer # 总数量
      
  # 相似音乐推荐
  GET /api/v1/recommendations/music/{musicId}/similar:
    描述: 获取相似音乐
    参数:
      limit: integer    # 返回数量
    响应:
      content: array    # 相似音乐列表
      
  # 用户行为记录
  POST /api/v1/recommendations/events:
    描述: 记录用户行为
    请求头:
      Authorization: Bearer <token>
    请求体:
      type: string      # 行为类型(view/like/share/play)
      musicId: string   # 音乐ID
      duration: integer # 播放时长(毫秒)
      timestamp: long   # 时间戳
    响应:
      success: boolean  # 记录结果
      
  # 推荐效果反馈
  POST /api/v1/recommendations/feedback:
    描述: 提交推荐反馈
    请求头:
      Authorization: Bearer <token>
    请求体:
      musicId: string   # 音乐ID
      score: integer    # 评分(1-5)
      comment: string   # 反馈内容
    响应:
      success: boolean  # 提交结果

数据模型:
  UserBehavior:
    - id: UUID (PK)
    - userId: UUID (FK)
    - musicId: UUID (FK)
    - type: Enum (VIEW, LIKE, SHARE, PLAY)
    - duration: Integer
    - timestamp: Timestamp
    - createdAt: Timestamp
    
  UserPreference:
    - id: UUID (PK)
    - userId: UUID (FK)
    - stylePreference: JSONB
    - tagPreference: JSONB
    - updatedAt: Timestamp
    
  RecommendationFeedback:
    - id: UUID (PK)
    - userId: UUID (FK)
    - musicId: UUID (FK)
    - score: Integer
    - comment: String
    - createdAt: Timestamp
```

## 4. 数据库设计

### 4.1 新增表结构
```sql
-- 用户行为表
CREATE TABLE user_behaviors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    music_id UUID NOT NULL REFERENCES music(id),
    type VARCHAR(20) NOT NULL,
    duration INTEGER,
    timestamp TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 用户偏好表
CREATE TABLE user_preferences (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) UNIQUE,
    style_preference JSONB NOT NULL DEFAULT '{}',
    tag_preference JSONB NOT NULL DEFAULT '{}',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 推荐反馈表
CREATE TABLE recommendation_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    music_id UUID NOT NULL REFERENCES music(id),
    score INTEGER NOT NULL CHECK (score BETWEEN 1 AND 5),
    comment VARCHAR(500),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_user_behaviors_user ON user_behaviors(user_id);
CREATE INDEX idx_user_behaviors_music ON user_behaviors(music_id);
CREATE INDEX idx_user_behaviors_type ON user_behaviors(type);
CREATE INDEX idx_user_behaviors_timestamp ON user_behaviors(timestamp);
CREATE INDEX idx_recommendation_feedback_user ON recommendation_feedback(user_id);
CREATE INDEX idx_recommendation_feedback_music ON recommendation_feedback(music_id);
```

## 5. 推荐算法设计

### 5.1 协同过滤算法
```yaml
用户相似度计算:
  方法: 余弦相似度
  特征:
    - 音乐风格偏好
    - 播放历史
    - 收藏记录
    - 社交关系
    
物品相似度计算:
  方法: 基于内容的相似度
  特征:
    - 音乐风格
    - 音频特征
    - 标签信息
    - 用户行为
    
模型更新策略:
  - 离线批量更新: 每日
  - 实时增量更新: 5分钟
  - 冷启动策略: 基于内容推荐
```

### 5.2 特征工程
```yaml
用户特征:
  - 基础属性
  - 行为序列
  - 时间特征
  - 社交特征
  
音乐特征:
  - 音频特征
  - 风格标签
  - 互动数据
  - 时序特征
  
上下文特征:
  - 时间段
  - 设备类型
  - 地理位置
  - 使用场景
```

## 6. 部署架构

### 6.1 开发环境
```yaml
docker-compose.yml:
  services:
    recommendation-service:
      build: ./recommendation-service
      ports:
        - "8083:8083"
      environment:
        - SPRING_PROFILES_ACTIVE=dev
        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/aimusic
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - SPRING_REDIS_HOST=redis
        - SPRING_REDIS_PORT=6379
        - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
        - ELASTICSEARCH_HOST=elasticsearch
        - ELASTICSEARCH_PORT=9200
        - JWT_SECRET=${JWT_SECRET}
      depends_on:
        - postgres
        - redis
        - kafka
        - elasticsearch
        - user-auth-service

    kafka:
      image: confluentinc/cp-kafka:7.4.0
      ports:
        - "9092:9092"
      environment:
        - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
        - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      volumes:
        - kafka_data:/var/lib/kafka/data

    elasticsearch:
      image: elasticsearch:8.11.0
      ports:
        - "9200:9200"
      environment:
        - discovery.type=single-node
        - xpack.security.enabled=false
      volumes:
        - elasticsearch_data:/usr/share/elasticsearch/data

    # 继承V0.3其他服务配置

volumes:
  kafka_data:
  elasticsearch_data:
  # 继承V0.3其他volumes
```

## 7. 缓存设计

### 7.1 Redis缓存策略
```yaml
用户特征缓存:
  key格式: "user:{userId}:features"
  类型: Hash
  过期时间: 1小时
  更新策略: Write Through

推荐结果缓存:
  key格式: "rec:{userId}:type:{type}:page:{page}"
  类型: List
  过期时间: 10分钟
  更新策略: Cache Aside

相似音乐缓存:
  key格式: "similar:{musicId}"
  类型: Sorted Set
  过期时间: 1天
  更新策略: Write Through

用户行为缓存:
  key格式: "behavior:{userId}:recent"
  类型: List
  过期时间: 永久
  容量限制: 1000条
```

## 8. 测试策略

### 8.1 测试范围
```yaml
单元测试:
  - 特征提取
  - 相似度计算
  - 推荐生成
  - 效果评估
  
集成测试:
  - 数据流处理
  - 模型训练
  - 推荐接口
  - 缓存交互
  
性能测试:
  - 推荐延迟
  - 并发处理
  - 缓存命中率
  - 资源消耗
```

## 9. 监控告警

### 9.1 监控指标
```yaml
系统指标:
  - API响应时间
  - 模型训练时间
  - 缓存命中率
  - 资源使用率
  
业务指标:
  - 推荐准确率
  - 点击转化率
  - 用户满意度
  - 覆盖率分析
```

## 10. 升级规划

下一版本(V0.5)计划:
1. 添加区块链激励系统
2. 实现创作者通证激励
3. 支持NFT音乐资产 