# AI音乐平台 V0.3 - 社交功能版本

## 1. 系统概述

V0.3版本在V0.2基础上添加了社交功能服务,实现用户关注、音乐分享和评论功能。

### 1.1 系统架构
```yaml
架构图:
                    ┌→ [用户认证服务8081]
  [前端Next.js] → [API网关] → [音乐生成服务8080]
                    └→ [社交功能服务8082]
                           ↓
                      [PostgreSQL]
```

### 1.2 核心功能
```yaml
继承V0.2功能:
  - AI音乐生成API调用
  - 音乐文件存储
  - 用户认证授权
  - 音乐收藏功能
  
新增功能:
  - 用户关注/取关
  - 音乐分享功能
  - 音乐评论系统
  - 用户动态流
  - 社交通知
```

## 2. 技术栈

### 2.1 后端技术
```yaml
框架与库:
  - Spring Boot 3.2
  - Spring Security
  - Spring Data JPA
  - Spring Web
  - Spring Actuator
  - Spring WebSocket
  - Lombok
  - MapStruct
  - OpenAPI (Swagger)
  - JJWT (JWT工具)

数据库:
  - PostgreSQL 14
  - Flyway (数据库迁移)
  - Redis (缓存&WebSocket)

构建工具:
  - Maven
  - Docker
  - Docker Compose

测试:
  - JUnit 5
  - Testcontainers
  - REST Assured
```

### 2.2 前端技术
```yaml
框架与库:
  - Next.js 14
  - React 18
  - TypeScript 5
  - TailwindCSS
  - Shadcn UI
  - React Query
  - Axios
  - Socket.IO Client
  - JWT Decode

构建工具:
  - Node.js 18
  - npm
```

## 3. 服务设计

### 3.1 社交功能服务 (social-service)
```yaml
端口: 8082
职责: 
  - 用户关系管理
  - 评论管理
  - 动态流生成
  - 实时通知

API接口:
  # 关注相关
  POST /api/v1/social/follow/{userId}:
    描述: 关注用户
    请求头:
      Authorization: Bearer <token>
    响应:
      success: boolean  # 操作结果
      
  DELETE /api/v1/social/follow/{userId}:
    描述: 取消关注
    请求头:
      Authorization: Bearer <token>
    响应:
      success: boolean  # 操作结果
      
  GET /api/v1/social/followers:
    描述: 获取粉丝列表
    请求头:
      Authorization: Bearer <token>
    参数:
      page: integer    # 页码
      size: integer    # 每页数量
    响应:
      content: array   # 用户列表
      totalElements: integer # 总数量
      
  GET /api/v1/social/following:
    描述: 获取关注列表
    请求头:
      Authorization: Bearer <token>
    参数:
      page: integer    # 页码
      size: integer    # 每页数量
    响应:
      content: array   # 用户列表
      totalElements: integer # 总数量
      
  # 评论相关
  POST /api/v1/social/music/{musicId}/comments:
    描述: 发表评论
    请求头:
      Authorization: Bearer <token>
    请求体:
      content: string  # 评论内容
      parentId?: string # 父评论ID(回复用)
    响应:
      id: string       # 评论ID
      content: string  # 评论内容
      createdAt: date  # 创建时间
      
  GET /api/v1/social/music/{musicId}/comments:
    描述: 获取音乐评论
    参数:
      page: integer    # 页码
      size: integer    # 每页数量
    响应:
      content: array   # 评论列表
      totalElements: integer # 总数量
      
  # 动态流相关
  GET /api/v1/social/feed:
    描述: 获取个人动态流
    请求头:
      Authorization: Bearer <token>
    参数:
      page: integer    # 页码
      size: integer    # 每页数量
    响应:
      content: array   # 动态列表
      totalElements: integer # 总数量

  # WebSocket通知
  WS /api/v1/social/notifications:
    描述: 实时通知连接
    事件:
      follow: 新粉丝通知
      comment: 新评论通知
      reply: 评论回复通知

数据模型:
  UserRelation:
    - id: UUID (PK)
    - followerId: UUID (FK)
    - followingId: UUID (FK)
    - createdAt: Timestamp
    
  Comment:
    - id: UUID (PK)
    - userId: UUID (FK)
    - musicId: UUID (FK)
    - parentId: UUID (FK, nullable)
    - content: String
    - createdAt: Timestamp
    - updatedAt: Timestamp
    
  Notification:
    - id: UUID (PK)
    - userId: UUID (FK)
    - type: Enum (FOLLOW, COMMENT, REPLY)
    - sourceId: UUID
    - read: Boolean
    - createdAt: Timestamp
```

## 4. 数据库设计

### 4.1 新增表结构
```sql
-- 用户关系表
CREATE TABLE user_relations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    follower_id UUID NOT NULL REFERENCES users(id),
    following_id UUID NOT NULL REFERENCES users(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(follower_id, following_id)
);

-- 评论表
CREATE TABLE comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    music_id UUID NOT NULL REFERENCES music(id),
    parent_id UUID REFERENCES comments(id),
    content VARCHAR(1000) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 通知表
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    type VARCHAR(20) NOT NULL,
    source_id UUID NOT NULL,
    read BOOLEAN NOT NULL DEFAULT false,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_user_relations_follower ON user_relations(follower_id);
CREATE INDEX idx_user_relations_following ON user_relations(following_id);
CREATE INDEX idx_comments_music ON comments(music_id);
CREATE INDEX idx_comments_user ON comments(user_id);
CREATE INDEX idx_comments_parent ON comments(parent_id);
CREATE INDEX idx_notifications_user ON notifications(user_id);
CREATE INDEX idx_notifications_unread ON notifications(user_id) WHERE NOT read;
```

## 5. 部署架构

### 5.1 开发环境
```yaml
docker-compose.yml:
  services:
    social-service:
      build: ./social-service
      ports:
        - "8082:8082"
      environment:
        - SPRING_PROFILES_ACTIVE=dev
        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/aimusic
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - SPRING_REDIS_HOST=redis
        - SPRING_REDIS_PORT=6379
        - JWT_SECRET=${JWT_SECRET}
      depends_on:
        - postgres
        - redis
        - user-auth-service

    user-auth-service:
      # 继承V0.2配置
      
    music-generation-service:
      # 继承V0.2配置

    postgres:
      # 继承V0.2配置

    redis:
      image: redis:7-alpine
      ports:
        - "6379:6379"
      volumes:
        - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

## 6. 缓存设计

### 6.1 Redis缓存策略
```yaml
关注关系缓存:
  key格式: "follow:{userId}:following"
  类型: Set
  过期时间: 1小时
  更新策略: Write Through

评论计数缓存:
  key格式: "music:{musicId}:comment_count"
  类型: String
  过期时间: 30分钟
  更新策略: Cache Aside

动态流缓存:
  key格式: "feed:{userId}:page:{pageNum}"
  类型: List
  过期时间: 5分钟
  更新策略: Cache Aside

通知计数缓存:
  key格式: "notify:{userId}:unread_count"
  类型: String
  过期时间: 永久
  更新策略: Write Through
```

## 7. 测试策略

### 7.1 测试范围
```yaml
单元测试:
  - 关注逻辑
  - 评论逻辑
  - 动态流生成
  - 通知处理
  
集成测试:
  - 用户关系管理
  - 评论系统功能
  - WebSocket通知
  - 缓存交互
  
E2E测试:
  - 关注/取关流程
  - 评论互动流程
  - 实时通知接收
```

## 8. 监控告警

### 8.1 监控指标
```yaml
系统指标:
  - API响应时间
  - WebSocket连接数
  - Redis命中率
  - 缓存使用量
  
业务指标:
  - 日活跃用户数
  - 评论互动量
  - 关注转化率
  - 通知送达率
```

## 9. 升级规划

下一版本(V0.4)计划:
1. 添加推荐系统服务
2. 实现个性化音乐推荐
3. 支持协同过滤推荐 