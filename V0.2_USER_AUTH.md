# AI音乐平台 V0.2 - 用户认证版本

## 1. 系统概述

V0.2版本在V0.1基础上添加了用户认证服务,实现用户注册、登录和音乐收藏功能。

### 1.1 系统架构
```yaml
架构图:
                    ┌→ [用户认证服务8081]
  [前端Next.js] → [API网关] 
                    └→ [音乐生成服务8080]
                           ↓
                      [PostgreSQL]
```

### 1.2 核心功能
```yaml
继承V0.1功能:
  - AI音乐生成API调用
  - 音乐文件存储
  - 基础音乐播放器
  
新增功能:
  - 用户注册与登录
  - JWT认证授权
  - 用户音乐收藏
  - 个人音乐列表
```

## 2. 技术栈

### 2.1 后端技术
```yaml
框架与库:
  - Spring Boot 3.2
  - Spring Security
  - Spring Data JPA
  - Spring Web
  - Spring Actuator
  - Lombok
  - MapStruct
  - OpenAPI (Swagger)
  - JJWT (JWT工具)

数据库:
  - PostgreSQL 14
  - Flyway (数据库迁移)

构建工具:
  - Maven
  - Docker
  - Docker Compose

测试:
  - JUnit 5
  - Testcontainers
  - REST Assured
```

### 2.2 前端技术
```yaml
框架与库:
  - Next.js 14
  - React 18
  - TypeScript 5
  - TailwindCSS
  - Shadcn UI
  - React Query
  - Axios
  - JWT Decode

构建工具:
  - Node.js 18
  - npm
```

## 3. 服务设计

### 3.1 用户认证服务 (user-auth-service)
```yaml
端口: 8081
职责: 
  - 用户账号管理
  - 认证授权
  - 令牌管理

API接口:
  POST /api/v1/auth/register:
    描述: 用户注册
    请求体:
      username: string   # 用户名
      email: string     # 邮箱
      password: string  # 密码
    响应:
      id: string        # 用户ID
      username: string  # 用户名
      email: string     # 邮箱
      
  POST /api/v1/auth/login:
    描述: 用户登录
    请求体:
      email: string     # 邮箱
      password: string  # 密码
    响应:
      token: string     # JWT令牌
      refreshToken: string # 刷新令牌
      
  GET /api/v1/users/me:
    描述: 获取当前用户信息
    请求头:
      Authorization: Bearer <token>
    响应:
      id: string        # 用户ID
      username: string  # 用户名
      email: string     # 邮箱
      createdAt: date   # 创建时间

数据模型:
  User:
    - id: UUID (PK)
    - username: String
    - email: String
    - password: String (加密)
    - createdAt: Timestamp
    - updatedAt: Timestamp
```

### 3.2 音乐生成服务更新 (music-generation-service)
```yaml
新增API:
  POST /api/v1/music/{id}/favorite:
    描述: 收藏/取消收藏音乐
    请求头:
      Authorization: Bearer <token>
    响应:
      success: boolean  # 操作结果
      
  GET /api/v1/music/favorites:
    描述: 获取收藏的音乐列表
    请求头:
      Authorization: Bearer <token>
    参数:
      page: integer     # 页码
      size: integer     # 每页数量
    响应:
      content: array    # 音乐列表
      totalElements: integer # 总数量
      totalPages: integer   # 总页数

新增数据模型:
  UserFavorite:
    - id: UUID (PK)
    - userId: UUID (FK)
    - musicId: UUID (FK)
    - createdAt: Timestamp
```

## 4. 数据库设计

### 4.1 新增表结构
```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- 用户收藏表
CREATE TABLE user_favorites (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    music_id UUID NOT NULL REFERENCES music(id),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, music_id)
);

-- 索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_user_favorites_user_id ON user_favorites(user_id);
CREATE INDEX idx_user_favorites_music_id ON user_favorites(music_id);
```

## 5. 部署架构

### 5.1 开发环境
```yaml
docker-compose.yml:
  services:
    user-auth-service:
      build: ./user-auth-service
      ports:
        - "8081:8081"
      environment:
        - SPRING_PROFILES_ACTIVE=dev
        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/aimusic
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - JWT_SECRET=${JWT_SECRET}
        - JWT_EXPIRATION=86400000
      depends_on:
        - postgres

    music-generation-service:
      build: ./music-generation-service
      ports:
        - "8080:8080"
      environment:
        - SPRING_PROFILES_ACTIVE=dev
        - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/aimusic
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - AI_API_KEY=${AI_API_KEY}
        - JWT_SECRET=${JWT_SECRET}
      depends_on:
        - postgres
        - user-auth-service

    postgres:
      image: postgres:14-alpine
      ports:
        - "5432:5432"
      environment:
        - POSTGRES_DB=aimusic
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres
      volumes:
        - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

## 6. 安全设计

### 6.1 认证授权
```yaml
JWT配置:
  - 密钥: 环境变量配置
  - 过期时间: 24小时
  - 刷新令牌: 7天
  
密码安全:
  - BCrypt加密
  - 密码强度校验
  - 登录失败限制
  
API安全:
  - 请求限流
  - CORS配置
  - XSS防护
```

## 7. 测试策略

### 7.1 测试范围
```yaml
单元测试:
  - 用户服务逻辑
  - 认证授权逻辑
  - 数据验证逻辑
  
集成测试:
  - 用户注册流程
  - 登录认证流程
  - 音乐收藏功能
  
E2E测试:
  - 用户注册登录
  - 音乐生成收藏
  - 权限控制验证
```

## 8. 监控告警

### 8.1 监控指标
```yaml
系统指标:
  - API响应时间
  - JVM内存使用
  - 数据库连接池
  - 线程池状态
  
业务指标:
  - 注册用户数
  - 活跃用户数
  - 登录成功率
  - 收藏音乐数
```

## 9. 升级规划

下一版本(V0.3)计划:
1. 添加社交功能服务
2. 实现用户关注
3. 支持音乐分享和评论 